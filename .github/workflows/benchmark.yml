name: run benchmark

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: # Specify your branches here
      - main # The 'main' branch
      - master # The 'master' branch
      - 'releases/*' # The release branches

permissions:
  contents: write
  pull-requests: write

# setup ubuntu-latest, jdk 21, gradle, mysql and run the benchmark
jobs:
  benchmark:
    name: Run benchmark
    runs-on: ubuntu-latest

    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0
          ref: main
          path: main

      - name: Checkout 🛎️
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0
          ref: result
          path: report-output

      - name: Set up JDK 21 ☕️
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'adopt'

      - name: Set up MySQL 8.0 🐬
        uses: ankane/setup-mysql@v1
        with:
          database: kronos_benchmark

      - name: Test MySQL connection 🔗
        run: mysql -D kronos_benchmark -e 'SELECT VERSION()'

      - name: Run benchmark 🧪
        working-directory: ./main
        run: |
          ./gradlew benchmark --info --stacktrace

      - name: Generate report 📊
        working-directory: ./main
        run: |
          set -e
          ./gradlew generateBenchmarkReport --info --stacktrace
          cd ../report-output
          find . -mindepth 1 -maxdepth 1 -not -name '.git' -exec rm -rf {} +
          cp -R ../main/build/reports/benchmark-report/* ./

      - name: Deploy to result branch 📦
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: result
          folder: ./report-output
          clean: true
          single-commit: true